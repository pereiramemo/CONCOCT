##############################################################################################
##############################################################################################
##############################################################################################
# CONCOCT preprocessing commands
##############################################################################################
##############################################################################################
##############################################################################################


#########################################
# cut up reads to 1000 pb
#########################################

sudo docker run -tiv $(pwd)/velvet_71.fa:/workspace/velvet_71.fa pre-process /bin/bash -c "cut_up_fasta.py -c 10000 -o 0 -m velvet_71.fa" > velvet_71_c10K.tmp1.fa 

#########################################
# map reads
#########################################

cd reads
READS=$(pwd)
cd ../
ASSEMBLY=$(pwd)
for f in reads/*_R1.fa; do
    mkdir -p map/$(basename $f);
    cd map/$(basename $f);
    f=$(basename $f);    
    mv $READS/$f .;
    mv $READS/$(echo $f | sed s/R1/R2/) .
    mv $ASSEMBLY/velvet_71_c10K.fa .;

    sudo docker run -tiv $(pwd):/workspace/ pre-process /bin/bash -c "map-bowtie2-markduplicates2.sh -m bbmap ct 1 -p '-f' $f  $(echo $f | sed s/R1/R2/) pair velvet_71_c10K.fa asm bowtie2;"		

    mv $f $READS;
    mv $(echo $f | sed s/R1/R2/) $READS;
    mv velvet_71_c10K.fa ../../;
    cd ../../;
done

########################################
# create coverage tables 
########################################

cd map
sudo docker run -tiv $(pwd):/workspace/ pre-process /bin/bash -c "gen_input_table.py --isbedfiles  --samplenames <(for s in Sample*; do echo $s | cut -d'_' -f1; done) ../velvet_71_c10K.fa asm_pair-smds.coverage > concoct_inputtable.tsv"


